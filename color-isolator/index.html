<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Color Isolator - Hover to Sample</title>
    <style>
      body {
          font-family: system-ui, -apple-system, sans-serif;
          background-color: #f4f4f9;
          color: #333;
          display: flex;
          flex-direction: column;
          align-items: center;
          padding: 20px;
          margin: 0;
      }
      .card {
          background: white;
          padding: 24px;
          border-radius: 16px;
          box-shadow: 0 10px 25px rgba(0,0,0,0.1);
          width: 100%;
          max-width: 1100px;
          text-align: center;
      }
      .controls {
          display: flex;
          flex-wrap: wrap;
          gap: 20px;
          justify-content: center;
          align-items: center;
          background: #f8f9fa;
          padding: 20px;
          border-radius: 12px;
          margin: 20px 0;
          position: sticky;
          top: 10px;
          z-index: 10;
          border: 1px solid #e0e0e0;
      }
      .canvas-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
          gap: 20px;
          margin-top: 20px;
      }
      .canvas-wrapper {
          display: flex;
          flex-direction: column;
          gap: 10px;
      }
      canvas {
          width: 100%;
          height: auto;
          border: 2px solid #eee;
          border-radius: 8px;
          cursor: crosshair;
          background-color: #fff;
          background-image: linear-gradient(45deg, #f0f0f0 25%, transparent 25%),
                            linear-gradient(-45deg, #f0f0f0 25%, transparent 25%),
                            linear-gradient(45deg, transparent 75%, #f0f0f0 75%),
                            linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
          background-size: 20px 20px;
      }
      .swatch-container {
          display: flex;
          align-items: center;
          gap: 10px;
          font-family: monospace;
          font-weight: bold;
          min-width: 180px;
      }
      .swatch {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          border: 3px solid white;
          box-shadow: 0 0 0 2px #ddd;
      }
      button {
          padding: 10px 20px;
          border: none;
          border-radius: 8px;
          background: #007bff;
          color: white;
          cursor: pointer;
          font-weight: 600;
          transition: background 0.2s;
      }
      button:hover { background: #0056b3; }
      button:disabled { background: #ccc; cursor: not-allowed; }
      input[type="range"] { cursor: pointer; }
      .hint { font-size: 0.85rem; color: #666; margin-top: 5px; }
      h3 { margin: 0; font-size: 1.1rem; color: #555; }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Color Isolator</h1>
      <p>Paste an image (<strong>Ctrl + V</strong>), then <strong>hover</strong> over the original to sample colors.</p>

      <button id="pasteBtn">Paste Image from Clipboard</button>

      <div class="controls">
        <div class="swatch-container">
          <span>Target:</span>
          <div id="colorSwatch" class="swatch" style="background-color: #DE8878;"></div>
          <span id="colorHex">#DE8878</span>
        </div>

        <div>
          <label style="display:block; margin-bottom: 5px;">Tolerance: <span id="tolValue">50</span></label>
          <input type="range" id="tolerance" min="0" max="200" value="50" style="width:200px" />
        </div>

        <button id="downloadBtn" disabled>Download Result</button>
      </div>

      <div class="canvas-grid">
        <div class="canvas-wrapper">
          <h3>Original (Hover to sample)</h3>
          <canvas id="sourceCanvas"></canvas>
        </div>
        <div class="canvas-wrapper">
          <h3>Result</h3>
          <canvas id="resultCanvas"></canvas>
        </div>
      </div>
    </div>

    <script>
      const sourceCanvas = document.getElementById("sourceCanvas");
      const resultCanvas = document.getElementById("resultCanvas");
      const sCtx = sourceCanvas.getContext("2d", { willReadFrequently: true });
      const rCtx = resultCanvas.getContext("2d");

      const toleranceInput = document.getElementById("tolerance");
      const tolValueDisplay = document.getElementById("tolValue");
      const colorSwatch = document.getElementById("colorSwatch");
      const colorHex = document.getElementById("colorHex");
      const downloadBtn = document.getElementById("downloadBtn");
      const pasteBtn = document.getElementById("pasteBtn");

      let targetRGB = { r: 222, g: 136, b: 120 };
      let originalImageData = null;

      function handleImage(file) {
        if (!file.type.startsWith("image/")) return;

        const img = new Image();
        img.onload = () => {
          sourceCanvas.width = resultCanvas.width = img.width;
          sourceCanvas.height = resultCanvas.height = img.height;
          sCtx.drawImage(img, 0, 0);
          originalImageData = sCtx.getImageData(0, 0, img.width, img.height);
          processImage();
          downloadBtn.disabled = false;
        };
        img.src = URL.createObjectURL(file);
      }

      // Paste Event
      window.addEventListener("paste", (e) => {
        const items = e.clipboardData.items;
        for (let item of items) {
          if (item.type.indexOf("image") !== -1) {
            handleImage(item.getAsFile());
          }
        }
      });

      pasteBtn.addEventListener("click", async () => {
        try {
          const clipboardItems = await navigator.clipboard.read();
          for (const item of clipboardItems) {
            for (const type of item.types) {
              if (type.startsWith("image/")) {
                const blob = await item.getType(type);
                handleImage(blob);
                return;
              }
            }
          }
        } catch (err) {
          alert("Please use Ctrl+V to paste.");
        }
      });

      // HOVER to sample color
      sourceCanvas.addEventListener("mousemove", (e) => {
        if (!originalImageData) return;

        const rect = sourceCanvas.getBoundingClientRect();
        const scaleX = sourceCanvas.width / rect.width;
        const scaleY = sourceCanvas.height / rect.height;
        const x = Math.floor((e.clientX - rect.left) * scaleX);
        const y = Math.floor((e.clientY - rect.top) * scaleY);

        // Ensure coordinates are within bounds
        if (x >= 0 && x < sourceCanvas.width && y >= 0 && y < sourceCanvas.height) {
          const pixel = sCtx.getImageData(x, y, 1, 1).data;

          // Only update if the pixel isn't fully transparent
          if (pixel[3] > 10) {
            targetRGB = { r: pixel[0], g: pixel[1], b: pixel[2] };

            const hex = "#" + ((1 << 24) + (targetRGB.r << 16) + (targetRGB.g << 8) + targetRGB.b).toString(16).slice(1).toUpperCase();
            colorHex.innerText = hex;
            colorSwatch.style.backgroundColor = hex;

            processImage();
          }
        }
      });

      toleranceInput.addEventListener("input", () => {
        tolValueDisplay.innerText = toleranceInput.value;
        processImage();
      });

      function processImage() {
        if (!originalImageData) return;

        const tolerance = parseInt(toleranceInput.value);
        const outputData = new ImageData(new Uint8ClampedArray(originalImageData.data), originalImageData.width, originalImageData.height);
        const data = outputData.data;

        for (let i = 0; i < data.length; i += 4) {
          const r = data[i];
          const g = data[i + 1];
          const b = data[i + 2];
          const a = data[i + 3];

          const distance = Math.sqrt(Math.pow(r - targetRGB.r, 2) + Math.pow(g - targetRGB.g, 2) + Math.pow(b - targetRGB.b, 2));

          if (distance > tolerance || a < 10) {
            data[i] = 255;
            data[i + 1] = 255;
            data[i + 2] = 255;
            data[i + 3] = 255;
          }
        }
        rCtx.putImageData(outputData, 0, 0);
      }

      downloadBtn.addEventListener("click", () => {
        const link = document.createElement("a");
        link.download = "isolated-color.png";
        link.href = resultCanvas.toDataURL();
        link.click();
      });
    </script>
  </body>
</html>
